name: Build B
on:
  workflow_call:
    inputs:
      buildError:
        required: true
        type: string
    secrets:
      personal_access_token:
        required: false
      AZURE_AI_ENDPOINT:
        required: true
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_TENANT_ID:
        required: true
      AGENT_ID:
        required: true

jobs:
  process-error:
    runs-on: ubuntu-latest
    steps:
      - name: Print received error
        run: |
          echo "===== RECEIVED BUILD ERROR ====="
          echo "${{ inputs.buildError }}"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install azure-ai-projects azure-identity

      - name: Send error to AI Agent
        env:
          AZURE_AI_ENDPOINT: ${{ secrets.AZURE_AI_ENDPOINT }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          BUILD_ERROR: ${{ inputs.buildError }}
        run: |
          python - <<'EOF'
          import os
          from azure.identity import ClientSecretCredential
          from azure.ai.projects import AIProjectClient
          from azure.ai.projects.models import ListSortOrder

          credential = ClientSecretCredential(
              tenant_id=os.environ["AZURE_TENANT_ID"],
              client_id=os.environ["AZURE_CLIENT_ID"],
              client_secret=os.environ["AZURE_CLIENT_SECRET"]
          )

          project = AIProjectClient(
              endpoint=os.environ["AZURE_AI_ENDPOINT"],
              credential=credential
          )

          agent = project.agents.get_agent(os.environ["AGENT_ID"])
          print(f"Agent retrieved: {agent.name}")

          thread = project.agents.threads.create()
          print(f"Thread created: {thread.id}")

          project.agents.messages.create(
              thread_id=thread.id,
              role="user",
              content=f"Analyze this build error and provide solution:\n\n{os.environ['BUILD_ERROR']}"
          )
          print("Message sent!")

          run = project.agents.runs.create_and_process(
              thread_id=thread.id,
              agent_id=agent.id
          )

          if run.status == "failed":
              print(f"Run failed: {run.last_error}")
          else:
              messages = project.agents.messages.list(
                  thread_id=thread.id,
                  order=ListSortOrder.ASCENDING
              )
              print("\n===== AI AGENT RESPONSE =====")
              for message in messages:
                  if message.text_messages:
                      for text in message.text_messages:
                          print(text.text.value)
          EOF

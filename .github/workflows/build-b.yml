name: Build B
on:
  workflow_call:
    inputs:
      buildError:
        required: true
        type: string
    secrets:
      personal_access_token:
        required: false
      AZURE_AI_ENDPOINT:
        required: true
      AZURE_AI_KEY:
        required: true
      AGENT_ID:
        required: true
jobs:
  process-error:
    runs-on: ubuntu-latest
    steps:
      - name: Print received error
        run: |
          echo "===== RECEIVED BUILD ERROR ====="
          echo "${{ inputs.buildError }}"
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install azure-ai-agents azure-core
      - name: Send error to AI Agent
        env:
          AZURE_AI_ENDPOINT: ${{ secrets.AZURE_AI_ENDPOINT }}
          AZURE_AI_KEY: ${{ secrets.AZURE_AI_KEY }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          BUILD_ERROR: ${{ inputs.buildError }}
        run: |
          python - <<'EOF'
          import os
          import requests
          import time

          endpoint = os.environ["AZURE_AI_ENDPOINT"].rstrip("/")
          api_key = os.environ["AZURE_AI_KEY"]
          build_error = os.environ["BUILD_ERROR"]
          agent_name = "ErrorDetectAgent"

          headers = {
              "Authorization": f"Bearer {api_key}",
              "Content-Type": "application/json"
          }

          # 1. Agent ID lo by name
          agents_res = requests.get(
              f"{endpoint}/agents?api-version=2025-05-15-preview",
              headers=headers
          )
          agents_res.raise_for_status()
          
          agent_id = None
          for agent in agents_res.json().get("value", []):
              if agent["name"] == agent_name:
                  agent_id = agent["id"]
                  break

          if not agent_id:
              print(f"Agent '{agent_name}' nahi mila!")
              exit(1)

          print(f"Agent found: {agent_id}")

          # 2. Thread banao
          thread_res = requests.post(
              f"{endpoint}/threads?api-version=2025-05-15-preview",
              headers=headers,
              json={}
          )
          thread_res.raise_for_status()
          thread_id = thread_res.json()["id"]
          print(f"Thread: {thread_id}")

          # 3. Message bhejo
          requests.post(
              f"{endpoint}/threads/{thread_id}/messages?api-version=2025-05-15-preview",
              headers=headers,
              json={
                  "role": "user",
                  "content": f"Yeh build error analyze karo aur solution do:\n\n{build_error}"
              }
          ).raise_for_status()
          print("Message sent!")

          # 4. Run karo
          run_res = requests.post(
              f"{endpoint}/threads/{thread_id}/runs?api-version=2025-05-15-preview",
              headers=headers,
              json={"assistant_id": agent_id}
          )
          run_res.raise_for_status()
          run_id = run_res.json()["id"]
          print(f"Run: {run_id}")

          # 5. Wait karo
          for i in range(30):
              time.sleep(3)
              status_res = requests.get(
                  f"{endpoint}/threads/{thread_id}/runs/{run_id}?api-version=2025-05-15-preview",
                  headers=headers
              )
              status = status_res.json()["status"]
              print(f"Status: {status}")
              if status == "completed":
                  break
              elif status in ["failed", "cancelled", "expired"]:
                  print("Run failed:", status_res.json())
                  exit(1)

          # 6. Response lo
          msgs_res = requests.get(
              f"{endpoint}/threads/{thread_id}/messages?api-version=2025-05-15-preview",
              headers=headers
          )
          for msg in msgs_res.json()["data"]:
              if msg["role"] == "assistant":
                  print("\n===== AI AGENT RESPONSE =====")
                  print(msg["content"][0]["text"]["value"])
                  break
          EOF

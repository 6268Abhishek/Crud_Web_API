name: Build B
on:
  workflow_call:
    inputs:
      buildError:
        required: true
        type: string
    secrets:
      personal_access_token:
        required: false
      AZURE_AI_ENDPOINT:
        required: true
      AZURE_AI_KEY:
        required: true
      AGENT_ID:
        required: true

jobs:
  process-error:
    runs-on: ubuntu-latest
    steps:
      - name: Print received error
        run: |
          echo "===== RECEIVED BUILD ERROR ====="
          echo "${{ inputs.buildError }}"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Create C# Project
        run: |
          mkdir -p /tmp/aiagent
          cd /tmp/aiagent
          dotnet new console -n AIAgent --force

      - name: Write C# Code
        env:
          BUILD_ERROR: ${{ inputs.buildError }}
        run: |
          cat > /tmp/aiagent/AIAgent/Program.cs << 'CSHARP'
          using System;
          using System.Net.Http;
          using System.Text;
          using System.Text.Json;
          using System.Threading;
          using System.Threading.Tasks;

          string endpoint = Environment.GetEnvironmentVariable("AZURE_AI_ENDPOINT")!.TrimEnd('/');
          string agentId = Environment.GetEnvironmentVariable("AGENT_ID")!;
          string buildError = Environment.GetEnvironmentVariable("BUILD_ERROR")!;
          string apiKey = Environment.GetEnvironmentVariable("AZURE_AI_KEY")!;

          string baseUrl = $"{endpoint}/openai";
          string apiVersion = "2024-05-01-preview";

          using var client = new HttpClient();
          client.DefaultRequestHeaders.Add("api-key", apiKey);

          // 1. Thread banao
          var threadRes = await client.PostAsync(
              $"{baseUrl}/threads?api-version={apiVersion}",
              new StringContent("{}", Encoding.UTF8, "application/json")
          );
          threadRes.EnsureSuccessStatusCode();
          var threadJson = JsonDocument.Parse(await threadRes.Content.ReadAsStringAsync());
          string threadId = threadJson.RootElement.GetProperty("id").GetString()!;
          Console.WriteLine($"Thread created: {threadId}");

          // 2. Message bhejo
          var msgBody = JsonSerializer.Serialize(new {
              role = "user",
              content = $"Analyze this build error and provide solution:\n\n{buildError}"
          });
          var msgRes = await client.PostAsync(
              $"{baseUrl}/threads/{threadId}/messages?api-version={apiVersion}",
              new StringContent(msgBody, Encoding.UTF8, "application/json")
          );
          msgRes.EnsureSuccessStatusCode();
          Console.WriteLine("Message sent!");

          // 3. Run karo
          var runBody = JsonSerializer.Serialize(new { assistant_id = agentId });
          var runRes = await client.PostAsync(
              $"{baseUrl}/threads/{threadId}/runs?api-version={apiVersion}",
              new StringContent(runBody, Encoding.UTF8, "application/json")
          );
          runRes.EnsureSuccessStatusCode();
          var runJson = JsonDocument.Parse(await runRes.Content.ReadAsStringAsync());
          string runId = runJson.RootElement.GetProperty("id").GetString()!;
          Console.WriteLine($"Run started: {runId}");

          // 4. Complete hone tak wait karo
          string status = "";
          for (int i = 0; i < 30; i++)
          {
              Thread.Sleep(3000);
              var statusRes = await client.GetAsync(
                  $"{baseUrl}/threads/{threadId}/runs/{runId}?api-version={apiVersion}"
              );
              var statusJson = JsonDocument.Parse(await statusRes.Content.ReadAsStringAsync());
              status = statusJson.RootElement.GetProperty("status").GetString()!;
              Console.WriteLine($"Status: {status}");
              if (status == "completed") break;
              if (status == "failed" || status == "cancelled" || status == "expired")
              {
                  Console.WriteLine("Run failed!");
                  Environment.Exit(1);
              }
          }

          // 5. Response lo
          var msgsRes = await client.GetAsync(
              $"{baseUrl}/threads/{threadId}/messages?api-version={apiVersion}"
          );
          msgsRes.EnsureSuccessStatusCode();
          var msgsJson = JsonDocument.Parse(await msgsRes.Content.ReadAsStringAsync());
          foreach (var msg in msgsJson.RootElement.GetProperty("data").EnumerateArray())
          {
              if (msg.GetProperty("role").GetString() == "assistant")
              {
                  Console.WriteLine("\n===== AI AGENT RESPONSE =====");
                  Console.WriteLine(
                      msg.GetProperty("content")[0]
                         .GetProperty("text")
                         .GetProperty("value")
                         .GetString()
                  );
                  break;
              }
          }
          CSHARP

      - name: Run C# Agent
        env:
          AZURE_AI_ENDPOINT: ${{ secrets.AZURE_AI_ENDPOINT }}
          AZURE_AI_KEY: ${{ secrets.AZURE_AI_KEY }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          BUILD_ERROR: ${{ inputs.buildError }}
        run: |
          cd /tmp/aiagent/AIAgent
          dotnet run
